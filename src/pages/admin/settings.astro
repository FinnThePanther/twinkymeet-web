---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { verifySessionToken } from '../../lib/auth';
import { getAllSettings, getAllAnnouncements } from '../../lib/db';

export const prerender = false;

// Check authentication
const sessionCookie = Astro.cookies.get('session')?.value;
const sessionSecret = (Astro.locals.runtime?.env?.SESSION_SECRET as string) || '';
const isAuthenticated =
  sessionCookie && sessionSecret && verifySessionToken(sessionCookie, sessionSecret);

if (!isAuthenticated) {
  return Astro.redirect('/admin/login');
}

// Fetch current settings
const db = Astro.locals.runtime.env.DB;
const settingsArray = await getAllSettings(db);
const settings: Record<string, string> = {};
settingsArray.forEach((s) => {
  settings[s.key] = s.value;
});

// Fetch all announcements
const announcements = await getAllAnnouncements(db);
---

<AdminLayout title="Site Settings">
  <div class="mx-auto max-w-5xl">
    <h1 class="mb-8 text-3xl font-bold text-gray-900">Site Settings</h1>

    <div class="space-y-8">
      <!-- Event Info Section -->
      <div class="rounded-lg bg-white shadow-sm">
        <div class="border-b border-gray-200 px-6 py-4">
          <h2 class="text-xl font-semibold text-gray-900">Event Information</h2>
          <p class="mt-1 text-sm text-gray-600">
            Configure basic event details
          </p>
        </div>
        <div class="p-6">
          <form id="event-info-form">
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label
                    for="event-start"
                    class="block text-sm font-medium text-gray-700"
                    >Start Date</label
                  >
                  <input
                    type="date"
                    id="event-start"
                    value={settings.event_date_start || ''}
                    class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                  />
                </div>
                <div>
                  <label
                    for="event-end"
                    class="block text-sm font-medium text-gray-700"
                    >End Date</label
                  >
                  <input
                    type="date"
                    id="event-end"
                    value={settings.event_date_end || ''}
                    class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                  />
                </div>
              </div>

              <div>
                <label
                  for="location"
                  class="block text-sm font-medium text-gray-700"
                  >Location</label
                >
                <input
                  type="text"
                  id="location"
                  value={settings.location || ''}
                  maxlength="255"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                />
              </div>
            </div>

            <div
              id="event-info-error"
              class="mt-4 hidden rounded-md border border-red-200 bg-red-50 p-3"
            >
              <p class="text-sm text-red-600"></p>
            </div>

            <div
              id="event-info-success"
              class="mt-4 hidden rounded-md border border-green-200 bg-green-50 p-3"
            >
              <p class="text-sm text-green-600">
                Event information updated successfully!
              </p>
            </div>

            <div class="mt-6">
              <button
                type="submit"
                id="save-event-info"
                class="rounded-md px-6 py-2 font-medium text-white shadow-sm"
                style="background-color: #4f46e5;"
              >
                Save Event Info
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Feature Toggles Section -->
      <div class="rounded-lg bg-white shadow-sm">
        <div class="border-b border-gray-200 px-6 py-4">
          <h2 class="text-xl font-semibold text-gray-900">Feature Toggles</h2>
          <p class="mt-1 text-sm text-gray-600">
            Enable or disable public forms
          </p>
        </div>
        <div class="p-6">
          <form id="feature-toggles-form">
            <div class="space-y-6">
              <!-- RSVP Toggle -->
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <h3 class="text-base font-medium text-gray-900">RSVP Form</h3>
                  <p class="text-sm text-gray-600">
                    Allow attendees to submit RSVPs
                  </p>
                </div>
                <label class="relative inline-flex cursor-pointer items-center">
                  <input
                    type="checkbox"
                    id="rsvp-toggle"
                    checked={settings.rsvp_open === 'true'}
                    class="peer sr-only"
                  />
                  <div
                    class="peer h-6 w-11 rounded-full bg-gray-200 peer-checked:bg-indigo-600 peer-focus:ring-4 peer-focus:ring-indigo-300 peer-focus:outline-none after:absolute after:top-[2px] after:left-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:after:translate-x-full peer-checked:after:border-white"
                  >
                  </div>
                </label>
              </div>

              <!-- Activity Submissions Toggle -->
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <h3 class="text-base font-medium text-gray-900">
                    Activity Submissions
                  </h3>
                  <p class="text-sm text-gray-600">
                    Allow attendees to propose activities
                  </p>
                </div>
                <label class="relative inline-flex cursor-pointer items-center">
                  <input
                    type="checkbox"
                    id="submissions-toggle"
                    checked={settings.activity_submissions_open === 'true'}
                    class="peer sr-only"
                  />
                  <div
                    class="peer h-6 w-11 rounded-full bg-gray-200 peer-checked:bg-indigo-600 peer-focus:ring-4 peer-focus:ring-indigo-300 peer-focus:outline-none after:absolute after:top-[2px] after:left-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:after:translate-x-full peer-checked:after:border-white"
                  >
                  </div>
                </label>
              </div>
            </div>

            <div
              id="toggles-success"
              class="mt-4 hidden rounded-md border border-green-200 bg-green-50 p-3"
            >
              <p class="text-sm text-green-600">
                Feature toggles updated successfully!
              </p>
            </div>

            <div class="mt-6">
              <button
                type="submit"
                id="save-toggles"
                class="rounded-md px-6 py-2 font-medium text-white shadow-sm"
                style="background-color: #4f46e5;"
              >
                Save Feature Toggles
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Announcements Section -->
      <div class="rounded-lg bg-white shadow-sm">
        <div class="border-b border-gray-200 px-6 py-4">
          <h2 class="text-xl font-semibold text-gray-900">Announcements</h2>
          <p class="mt-1 text-sm text-gray-600">
            Manage site-wide announcements displayed to attendees
          </p>
        </div>
        <div class="p-6">
          <!-- Add New Announcement Form -->
          <form id="add-announcement-form" class="mb-6">
            <div class="flex gap-3">
              <input
                type="text"
                id="new-announcement"
                placeholder="Enter a new announcement..."
                maxlength="500"
                class="flex-1 rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              />
              <button
                type="submit"
                id="add-announcement-btn"
                class="rounded-md px-6 py-2 font-medium text-white shadow-sm"
                style="background-color: #16a34a;"
              >
                Add
              </button>
            </div>
            <div
              id="announcement-error"
              class="mt-2 hidden rounded-md border border-red-200 bg-red-50 p-3"
            >
              <p class="text-sm text-red-600"></p>
            </div>
          </form>

          <!-- Announcements List -->
          {
            announcements.length === 0 ? (
              <div class="py-8 text-center text-gray-500">
                <p>No announcements yet. Add one above to get started.</p>
              </div>
            ) : (
              <div class="space-y-3" id="announcements-list">
                {announcements.map((announcement) => (
                  <div
                    class="announcement-item flex items-start gap-3 rounded-md border border-gray-200 p-4"
                    data-id={announcement.id}
                  >
                    <div class="flex-1">
                      <p class="announcement-text text-gray-900">
                        {announcement.message}
                      </p>
                      <p class="mt-1 text-xs text-gray-500">
                        {new Date(announcement.created_at!).toLocaleDateString(
                          'en-US',
                          {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                          }
                        )}
                      </p>
                    </div>
                    <div class="flex items-center gap-2">
                      <span
                        class={`rounded-full px-2 py-1 text-xs font-medium ${
                          announcement.active === 1
                            ? 'bg-green-100 text-green-800'
                            : 'bg-gray-100 text-gray-800'
                        }`}
                      >
                        {announcement.active === 1 ? 'Active' : 'Inactive'}
                      </span>
                      <button
                        class="toggle-active-btn px-2 py-1 text-sm text-indigo-600 hover:text-indigo-700"
                        data-id={announcement.id}
                        data-active={announcement.active}
                      >
                        {announcement.active === 1 ? 'Deactivate' : 'Activate'}
                      </button>
                      <button
                        class="delete-announcement-btn px-2 py-1 text-sm text-red-600 hover:text-red-700"
                        data-id={announcement.id}
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )
          }
        </div>
      </div>
    </div>
  </div>

  <script>
    // Event Info Form
    const eventInfoForm = document.getElementById(
      'event-info-form'
    ) as HTMLFormElement;
    const eventInfoError = document.getElementById('event-info-error');
    const eventInfoSuccess = document.getElementById('event-info-success');
    const saveEventInfoBtn = document.getElementById(
      'save-event-info'
    ) as HTMLButtonElement;

    eventInfoForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      saveEventInfoBtn.disabled = true;
      saveEventInfoBtn.textContent = 'Saving...';
      eventInfoError?.classList.add('hidden');
      eventInfoSuccess?.classList.add('hidden');

      const data = {
        event_date_start: (
          document.getElementById('event-start') as HTMLInputElement
        ).value,
        event_date_end: (
          document.getElementById('event-end') as HTMLInputElement
        ).value,
        location: (document.getElementById('location') as HTMLInputElement)
          .value,
      };

      try {
        const response = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          eventInfoSuccess?.classList.remove('hidden');
          setTimeout(() => eventInfoSuccess?.classList.add('hidden'), 3000);
        } else {
          const errorMsg = result.error || 'Failed to update event information';
          if (eventInfoError) {
            eventInfoError.querySelector('p')!.textContent = errorMsg;
            eventInfoError.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error updating event info:', error);
        if (eventInfoError) {
          eventInfoError.querySelector('p')!.textContent = 'An error occurred';
          eventInfoError.classList.remove('hidden');
        }
      } finally {
        saveEventInfoBtn.disabled = false;
        saveEventInfoBtn.textContent = 'Save Event Info';
      }
    });

    // Feature Toggles Form
    const togglesForm = document.getElementById(
      'feature-toggles-form'
    ) as HTMLFormElement;
    const togglesSuccess = document.getElementById('toggles-success');
    const saveTogglesBtn = document.getElementById(
      'save-toggles'
    ) as HTMLButtonElement;

    togglesForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      saveTogglesBtn.disabled = true;
      saveTogglesBtn.textContent = 'Saving...';
      togglesSuccess?.classList.add('hidden');

      const data = {
        rsvp_open: (document.getElementById('rsvp-toggle') as HTMLInputElement)
          .checked,
        activity_submissions_open: (
          document.getElementById('submissions-toggle') as HTMLInputElement
        ).checked,
      };

      try {
        const response = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          togglesSuccess?.classList.remove('hidden');
          setTimeout(() => togglesSuccess?.classList.add('hidden'), 3000);
        } else {
          alert('Failed to update feature toggles');
        }
      } catch (error) {
        console.error('Error updating toggles:', error);
        alert('An error occurred');
      } finally {
        saveTogglesBtn.disabled = false;
        saveTogglesBtn.textContent = 'Save Feature Toggles';
      }
    });

    // Add Announcement
    const addAnnouncementForm = document.getElementById(
      'add-announcement-form'
    ) as HTMLFormElement;
    const announcementError = document.getElementById('announcement-error');
    const addAnnouncementBtn = document.getElementById(
      'add-announcement-btn'
    ) as HTMLButtonElement;

    addAnnouncementForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const input = document.getElementById(
        'new-announcement'
      ) as HTMLInputElement;
      const message = input.value.trim();

      if (!message) {
        if (announcementError) {
          announcementError.querySelector('p')!.textContent =
            'Please enter an announcement message';
          announcementError.classList.remove('hidden');
        }
        return;
      }

      addAnnouncementBtn.disabled = true;
      addAnnouncementBtn.textContent = 'Adding...';
      announcementError?.classList.add('hidden');

      try {
        const response = await fetch('/api/admin/announcements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message }),
        });

        if (response.ok) {
          window.location.reload();
        } else {
          if (announcementError) {
            announcementError.querySelector('p')!.textContent =
              'Failed to add announcement';
            announcementError.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error adding announcement:', error);
        if (announcementError) {
          announcementError.querySelector('p')!.textContent =
            'An error occurred';
          announcementError.classList.remove('hidden');
        }
      } finally {
        addAnnouncementBtn.disabled = false;
        addAnnouncementBtn.textContent = 'Add';
      }
    });

    // Toggle Active
    document.querySelectorAll('.toggle-active-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const id = button.dataset.id;
        const currentActive = button.dataset.active === '1';

        button.disabled = true;

        try {
          const response = await fetch(
            `/api/admin/announcements/${id}/toggle`,
            {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ active: !currentActive }),
            }
          );

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Failed to toggle announcement');
          }
        } catch (error) {
          console.error('Error toggling announcement:', error);
          alert('An error occurred');
        } finally {
          button.disabled = false;
        }
      });
    });

    // Delete Announcement
    document.querySelectorAll('.delete-announcement-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const id = button.dataset.id;

        if (!confirm('Are you sure you want to delete this announcement?')) {
          return;
        }

        button.disabled = true;

        try {
          const response = await fetch(`/api/admin/announcements/${id}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Failed to delete announcement');
          }
        } catch (error) {
          console.error('Error deleting announcement:', error);
          alert('An error occurred');
        } finally {
          button.disabled = false;
        }
      });
    });
  </script>
</AdminLayout>
