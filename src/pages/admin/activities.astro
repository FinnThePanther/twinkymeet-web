---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getAllActivities } from '../../lib/db';
import { verifySessionToken } from '../../lib/auth';

export const prerender = false;

// Check authentication
const sessionCookie = Astro.cookies.get('session')?.value;
const sessionSecret = import.meta.env.SESSION_SECRET || '';
const isAuthenticated =
  sessionCookie && verifySessionToken(sessionCookie, sessionSecret);

if (!isAuthenticated) {
  return Astro.redirect('/admin/login');
}

// Fetch all activities
const activities = getAllActivities();
---

<AdminLayout title="Manage Activities">
  <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900">Manage Activities</h1>
    </div>

    <!-- Status Filter Tabs -->
    <div class="mb-6 border-b border-gray-200">
      <nav class="-mb-px flex space-x-8">
        <button
          data-filter="all"
          class="filter-tab border-b-2 border-blue-500 px-1 py-4 text-sm font-medium text-blue-600"
        >
          All ({activities.length})
        </button>
        <button
          data-filter="pending"
          class="filter-tab border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
        >
          Pending ({activities.filter((a) => a.status === 'pending').length})
        </button>
        <button
          data-filter="approved"
          class="filter-tab border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
        >
          Approved ({activities.filter((a) => a.status === 'approved').length})
        </button>
        <button
          data-filter="scheduled"
          class="filter-tab border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
        >
          Scheduled ({
            activities.filter((a) => a.status === 'scheduled').length
          })
        </button>
      </nav>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
      <input
        type="text"
        id="search-input"
        placeholder="Search by title or host name..."
        class="w-full rounded-md border border-gray-300 px-4 py-2 focus:border-blue-500 focus:ring-blue-500"
      />
    </div>

    <!-- Activities List -->
    <div id="activities-container" class="space-y-4">
      {
        activities.length === 0 ? (
          <div class="rounded-lg bg-white py-12 text-center shadow">
            <p class="text-gray-500">No activities submitted yet.</p>
          </div>
        ) : (
          activities.map((activity) => (
            <div
              class="activity-card rounded-lg bg-white p-6 shadow"
              data-activity-id={activity.id}
              data-status={activity.status}
              data-title={activity.title.toLowerCase()}
              data-host={activity.host_name.toLowerCase()}
              data-activity-data={JSON.stringify(activity)}
            >
              <div class="mb-4 flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="text-xl font-semibold text-gray-900">
                    {activity.title}
                  </h3>
                  <p class="mt-1 text-sm text-gray-600">
                    Hosted by {activity.host_name} ({activity.host_email})
                  </p>
                </div>
                <span
                  class={`rounded-full px-3 py-1 text-sm font-medium ${
                    activity.status === 'pending'
                      ? 'bg-yellow-100 text-yellow-800'
                      : activity.status === 'approved'
                        ? 'bg-blue-100 text-blue-800'
                        : activity.status === 'scheduled'
                          ? 'bg-green-100 text-green-800'
                          : 'bg-gray-100 text-gray-800'
                  }`}
                >
                  {activity.status.charAt(0).toUpperCase() +
                    activity.status.slice(1)}
                </span>
              </div>

              {activity.description && (
                <p class="mb-4 text-gray-700">{activity.description}</p>
              )}

              <div class="mb-4 grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="font-medium text-gray-700">Duration:</span>
                  <span class="text-gray-600">
                    {' '}
                    {activity.duration} minutes
                  </span>
                </div>
                {activity.activity_type && (
                  <div>
                    <span class="font-medium text-gray-700">Type:</span>
                    <span class="text-gray-600"> {activity.activity_type}</span>
                  </div>
                )}
                {activity.capacity && (
                  <div>
                    <span class="font-medium text-gray-700">Capacity:</span>
                    <span class="text-gray-600">
                      {' '}
                      {activity.capacity} people
                    </span>
                  </div>
                )}
                {activity.equipment_needed && (
                  <div class="col-span-2">
                    <span class="font-medium text-gray-700">
                      Equipment Needed:
                    </span>
                    <span class="text-gray-600">
                      {' '}
                      {activity.equipment_needed}
                    </span>
                  </div>
                )}
                {activity.time_preference && (
                  <div class="col-span-2">
                    <span class="font-medium text-gray-700">
                      Time Preference:
                    </span>
                    <span class="text-gray-600">
                      {' '}
                      {activity.time_preference}
                    </span>
                  </div>
                )}
                {activity.scheduled_start && activity.scheduled_end && (
                  <div class="col-span-2">
                    <span class="font-medium text-gray-700">Scheduled:</span>
                    <span class="text-gray-600">
                      {' '}
                      {new Date(
                        activity.scheduled_start
                      ).toLocaleString()} -{' '}
                      {new Date(activity.scheduled_end).toLocaleString()}
                    </span>
                  </div>
                )}
                {activity.location && (
                  <div class="col-span-2">
                    <span class="font-medium text-gray-700">Location:</span>
                    <span class="text-gray-600"> {activity.location}</span>
                  </div>
                )}
                {activity.notes && (
                  <div class="col-span-2">
                    <span class="font-medium text-gray-700">Notes:</span>
                    <span class="text-gray-600"> {activity.notes}</span>
                  </div>
                )}
              </div>

              {/* Action Buttons (will be shown/hidden based on status) */}
              <div class="mt-4 flex flex-wrap gap-2">
                {activity.status === 'pending' && (
                  <button
                    type="button"
                    class="approve-btn rounded-md px-4 py-2 font-medium text-white shadow-sm"
                    style="background-color: #16a34a;"
                    data-activity-id={activity.id}
                  >
                    Approve
                  </button>
                )}
                {activity.status === 'approved' && (
                  <button
                    type="button"
                    class="schedule-btn rounded-md px-4 py-2 font-medium text-white shadow-sm"
                    style="background-color: #16a34a;"
                    data-activity-id={activity.id}
                  >
                    Schedule
                  </button>
                )}
                <button
                  type="button"
                  class="edit-btn rounded-md px-4 py-2 font-medium text-white shadow-sm"
                  style="background-color: #2563eb;"
                  data-activity-id={activity.id}
                >
                  Edit
                </button>
                {activity.status === 'approved' && (
                  <button
                    type="button"
                    class="unapprove-btn rounded-md px-4 py-2 font-medium text-white shadow-sm"
                    style="background-color: #4b5563;"
                    data-activity-id={activity.id}
                  >
                    Unapprove
                  </button>
                )}
                {activity.status === 'scheduled' && (
                  <button
                    type="button"
                    class="unschedule-btn rounded-md px-4 py-2 font-medium text-white shadow-sm"
                    style="background-color: #4b5563;"
                    data-activity-id={activity.id}
                  >
                    Unschedule
                  </button>
                )}
                <button
                  type="button"
                  class="delete-btn rounded-md bg-red-600 px-4 py-2 font-medium text-white shadow-sm hover:bg-red-700"
                  data-activity-id={activity.id}
                >
                  Delete
                </button>
              </div>
            </div>
          ))
        )
      }
    </div>

    <!-- Empty State for Filtered Results -->
    <div
      id="no-results"
      class="hidden rounded-lg bg-white py-12 text-center shadow"
    >
      <p class="text-gray-500">No activities match your current filter.</p>
    </div>
  </div>

  <!-- Edit Modal -->
  <div
    id="edit-modal"
    class="bg-opacity-50 fixed inset-0 z-50 hidden h-full w-full overflow-y-auto bg-gray-600"
  >
    <div
      class="relative top-20 mx-auto w-full max-w-2xl rounded-md border bg-white p-5 shadow-lg"
    >
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">Edit Activity</h3>
        <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="edit-form">
        <input type="hidden" id="edit-activity-id" />

        <div class="space-y-4">
          <div>
            <label
              for="edit-title"
              class="block text-sm font-medium text-gray-700">Title *</label
            >
            <input
              type="text"
              id="edit-title"
              required
              maxlength="255"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="edit-description"
              class="block text-sm font-medium text-gray-700">Description</label
            >
            <textarea
              id="edit-description"
              rows="3"
              maxlength="2000"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            ></textarea>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                for="edit-host-name"
                class="block text-sm font-medium text-gray-700"
                >Host Name *</label
              >
              <input
                type="text"
                id="edit-host-name"
                required
                maxlength="255"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>

            <div>
              <label
                for="edit-host-email"
                class="block text-sm font-medium text-gray-700"
                >Host Email *</label
              >
              <input
                type="email"
                id="edit-host-email"
                required
                maxlength="255"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                for="edit-duration"
                class="block text-sm font-medium text-gray-700"
                >Duration (minutes) *</label
              >
              <input
                type="number"
                id="edit-duration"
                required
                min="1"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>

            <div>
              <label
                for="edit-capacity"
                class="block text-sm font-medium text-gray-700">Capacity</label
              >
              <input
                type="number"
                id="edit-capacity"
                min="0"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>

          <div>
            <label
              for="edit-activity-type"
              class="block text-sm font-medium text-gray-700"
              >Activity Type</label
            >
            <input
              type="text"
              id="edit-activity-type"
              maxlength="100"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="edit-equipment"
              class="block text-sm font-medium text-gray-700"
              >Equipment Needed</label
            >
            <textarea
              id="edit-equipment"
              rows="2"
              maxlength="500"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            ></textarea>
          </div>

          <div>
            <label
              for="edit-time-preference"
              class="block text-sm font-medium text-gray-700"
              >Time Preference</label
            >
            <textarea
              id="edit-time-preference"
              rows="2"
              maxlength="500"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            ></textarea>
          </div>

          <div>
            <label
              for="edit-notes"
              class="block text-sm font-medium text-gray-700">Notes</label
            >
            <textarea
              id="edit-notes"
              rows="2"
              maxlength="1000"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            ></textarea>
          </div>

          <div>
            <label
              for="edit-status"
              class="block text-sm font-medium text-gray-700">Status</label
            >
            <select
              id="edit-status"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            >
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="scheduled">Scheduled</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          <!-- Schedule fields (shown only if status is scheduled) -->
          <div id="schedule-fields" class="hidden space-y-4 border-t pt-4">
            <div>
              <label
                for="edit-scheduled-start"
                class="block text-sm font-medium text-gray-700"
                >Scheduled Start</label
              >
              <input
                type="datetime-local"
                id="edit-scheduled-start"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>

            <div>
              <label
                for="edit-scheduled-end"
                class="block text-sm font-medium text-gray-700"
                >Scheduled End</label
              >
              <input
                type="datetime-local"
                id="edit-scheduled-end"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>

            <div>
              <label
                for="edit-location"
                class="block text-sm font-medium text-gray-700">Location</label
              >
              <input
                type="text"
                id="edit-location"
                maxlength="255"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        <div
          id="edit-error"
          class="mt-4 hidden rounded-md border border-red-200 bg-red-50 p-3"
        >
          <p class="text-sm text-red-600"></p>
        </div>

        <div class="mt-6 flex justify-end gap-3">
          <button
            type="button"
            id="cancel-edit"
            class="rounded-md border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="save-edit"
            class="rounded-md px-4 py-2 font-medium text-white shadow-sm"
            style="background-color: #2563eb;"
          >
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div
    id="schedule-modal"
    class="bg-opacity-50 fixed inset-0 z-50 hidden h-full w-full overflow-y-auto bg-gray-600"
  >
    <div
      class="relative top-20 mx-auto w-full max-w-lg rounded-md border bg-white p-5 shadow-lg"
    >
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">Schedule Activity</h3>
        <button
          id="close-schedule-modal"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="schedule-form">
        <input type="hidden" id="schedule-activity-id" />

        <div class="space-y-4">
          <div>
            <p class="mb-4 text-sm text-gray-600">
              Activity: <span
                id="schedule-activity-title"
                class="font-medium text-gray-900"></span>
            </p>
          </div>

          <div>
            <label
              for="schedule-start"
              class="block text-sm font-medium text-gray-700"
              >Start Time *</label
            >
            <input
              type="datetime-local"
              id="schedule-start"
              required
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="schedule-end"
              class="block text-sm font-medium text-gray-700">End Time *</label
            >
            <input
              type="datetime-local"
              id="schedule-end"
              required
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="schedule-location"
              class="block text-sm font-medium text-gray-700">Location *</label
            >
            <input
              type="text"
              id="schedule-location"
              required
              maxlength="255"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
        </div>

        <div
          id="schedule-error"
          class="mt-4 hidden rounded-md border border-red-200 bg-red-50 p-3"
        >
          <p class="text-sm text-red-600"></p>
        </div>

        <div class="mt-6 flex justify-end gap-3">
          <button
            type="button"
            id="cancel-schedule"
            class="rounded-md border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="save-schedule"
            class="rounded-md px-4 py-2 font-medium text-white shadow-sm"
            style="background-color: #16a34a;"
          >
            Schedule Activity
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div
    id="delete-modal"
    class="bg-opacity-50 fixed inset-0 z-50 hidden h-full w-full overflow-y-auto bg-gray-600"
  >
    <div
      class="relative top-20 mx-auto w-96 rounded-md border bg-white p-5 shadow-lg"
    >
      <div class="mt-3">
        <h3 class="mb-4 text-lg font-medium text-gray-900">Confirm Delete</h3>
        <p class="mb-6 text-sm text-gray-500">
          Are you sure you want to delete this activity? This action cannot be
          undone.
        </p>
        <input type="hidden" id="delete-activity-id" />
        <div class="flex justify-end gap-3">
          <button
            id="cancel-delete"
            class="rounded-md border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            id="confirm-delete"
            class="rounded-md bg-red-600 px-4 py-2 text-white hover:bg-red-700"
          >
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Store activities data
    const activitiesData: any[] = [];
    document.querySelectorAll('.activity-card').forEach((card) => {
      const dataAttr = (card as HTMLElement).dataset.activityData;
      if (dataAttr) {
        activitiesData.push(JSON.parse(dataAttr));
      }
    });

    // Filter tabs
    const filterTabs = document.querySelectorAll('.filter-tab');
    const activitiesContainer = document.getElementById('activities-container');
    const noResults = document.getElementById('no-results');
    const searchInput = document.getElementById(
      'search-input'
    ) as HTMLInputElement;

    let currentFilter = 'all';

    filterTabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const filter = (tab as HTMLElement).dataset.filter || 'all';
        currentFilter = filter;

        // Update active tab styling
        filterTabs.forEach((t) => {
          t.classList.remove('border-blue-500', 'text-blue-600');
          t.classList.add('border-transparent', 'text-gray-500');
        });
        tab.classList.remove('border-transparent', 'text-gray-500');
        tab.classList.add('border-blue-500', 'text-blue-600');

        filterActivities();
      });
    });

    // Search functionality
    searchInput?.addEventListener('input', filterActivities);

    function filterActivities() {
      const searchTerm = searchInput?.value.toLowerCase() || '';
      const cards = document.querySelectorAll('.activity-card');
      let visibleCount = 0;

      cards.forEach((card) => {
        const htmlCard = card as HTMLElement;
        const status = htmlCard.dataset.status || '';
        const title = htmlCard.dataset.title || '';
        const host = htmlCard.dataset.host || '';

        const matchesFilter =
          currentFilter === 'all' || status === currentFilter;
        const matchesSearch =
          title.includes(searchTerm) || host.includes(searchTerm);

        if (matchesFilter && matchesSearch) {
          htmlCard.style.display = '';
          visibleCount++;
        } else {
          htmlCard.style.display = 'none';
        }
      });

      // Show/hide no results message
      if (visibleCount === 0 && cards.length > 0) {
        activitiesContainer!.classList.add('hidden');
        noResults!.classList.remove('hidden');
      } else {
        activitiesContainer!.classList.remove('hidden');
        noResults!.classList.add('hidden');
      }
    }

    // Approve button handlers
    document.querySelectorAll('.approve-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const activityId = button.dataset.activityId;

        button.disabled = true;
        button.textContent = 'Approving...';

        try {
          const response = await fetch(
            `/api/admin/activities/${activityId}/approve`,
            {
              method: 'PATCH',
            }
          );

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Failed to approve activity');
            button.disabled = false;
            button.textContent = 'Approve';
          }
        } catch (error) {
          console.error('Error approving activity:', error);
          alert('An error occurred');
          button.disabled = false;
          button.textContent = 'Approve';
        }
      });
    });

    // Unapprove button handlers
    document.querySelectorAll('.unapprove-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const activityId = button.dataset.activityId;

        button.disabled = true;
        button.textContent = 'Processing...';

        try {
          const response = await fetch(`/api/admin/activities/${activityId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'pending' }),
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Failed to unapprove activity');
            button.disabled = false;
            button.textContent = 'Unapprove';
          }
        } catch (error) {
          console.error('Error unapproving activity:', error);
          alert('An error occurred');
          button.disabled = false;
          button.textContent = 'Unapprove';
        }
      });
    });

    // Unschedule button handlers
    document.querySelectorAll('.unschedule-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const activityId = button.dataset.activityId;

        button.disabled = true;
        button.textContent = 'Processing...';

        try {
          const response = await fetch(`/api/admin/activities/${activityId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              status: 'approved',
              scheduled_start: null,
              scheduled_end: null,
              location: null,
            }),
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Failed to unschedule activity');
            button.disabled = false;
            button.textContent = 'Unschedule';
          }
        } catch (error) {
          console.error('Error unscheduling activity:', error);
          alert('An error occurred');
          button.disabled = false;
          button.textContent = 'Unschedule';
        }
      });
    });

    // Edit Modal
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form') as HTMLFormElement;
    const editError = document.getElementById('edit-error');
    const scheduleFields = document.getElementById('schedule-fields');
    const editStatusSelect = document.getElementById(
      'edit-status'
    ) as HTMLSelectElement;

    // Show/hide schedule fields based on status
    editStatusSelect?.addEventListener('change', () => {
      if (editStatusSelect.value === 'scheduled') {
        scheduleFields?.classList.remove('hidden');
      } else {
        scheduleFields?.classList.add('hidden');
      }
    });

    document.querySelectorAll('.edit-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const button = e.target as HTMLButtonElement;
        const activityId = button.dataset.activityId;
        const activity = activitiesData.find(
          (a) => a.id === parseInt(activityId || '0')
        );

        if (activity) {
          (
            document.getElementById('edit-activity-id') as HTMLInputElement
          ).value = activity.id;
          (document.getElementById('edit-title') as HTMLInputElement).value =
            activity.title || '';
          (
            document.getElementById('edit-description') as HTMLTextAreaElement
          ).value = activity.description || '';
          (
            document.getElementById('edit-host-name') as HTMLInputElement
          ).value = activity.host_name || '';
          (
            document.getElementById('edit-host-email') as HTMLInputElement
          ).value = activity.host_email || '';
          (document.getElementById('edit-duration') as HTMLInputElement).value =
            activity.duration || '';
          (document.getElementById('edit-capacity') as HTMLInputElement).value =
            activity.capacity || '';
          (
            document.getElementById('edit-activity-type') as HTMLInputElement
          ).value = activity.activity_type || '';
          (
            document.getElementById('edit-equipment') as HTMLTextAreaElement
          ).value = activity.equipment_needed || '';
          (
            document.getElementById(
              'edit-time-preference'
            ) as HTMLTextAreaElement
          ).value = activity.time_preference || '';
          (document.getElementById('edit-notes') as HTMLTextAreaElement).value =
            activity.notes || '';
          editStatusSelect.value = activity.status || 'pending';

          // Handle schedule fields
          if (activity.status === 'scheduled') {
            scheduleFields?.classList.remove('hidden');
            if (activity.scheduled_start) {
              const startDate = new Date(activity.scheduled_start);
              (
                document.getElementById(
                  'edit-scheduled-start'
                ) as HTMLInputElement
              ).value = startDate.toISOString().slice(0, 16);
            }
            if (activity.scheduled_end) {
              const endDate = new Date(activity.scheduled_end);
              (
                document.getElementById(
                  'edit-scheduled-end'
                ) as HTMLInputElement
              ).value = endDate.toISOString().slice(0, 16);
            }
            (
              document.getElementById('edit-location') as HTMLInputElement
            ).value = activity.location || '';
          } else {
            scheduleFields?.classList.add('hidden');
          }

          editModal?.classList.remove('hidden');
        }
      });
    });

    function closeEditModal() {
      editModal?.classList.add('hidden');
      editForm?.reset();
      editError?.classList.add('hidden');
      scheduleFields?.classList.add('hidden');
    }

    document
      .getElementById('close-edit-modal')
      ?.addEventListener('click', closeEditModal);
    document
      .getElementById('cancel-edit')
      ?.addEventListener('click', closeEditModal);

    editForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const activityId = (
        document.getElementById('edit-activity-id') as HTMLInputElement
      ).value;
      const saveBtn = document.getElementById('save-edit') as HTMLButtonElement;

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const data: Record<string, any> = {
        title: (document.getElementById('edit-title') as HTMLInputElement)
          .value,
        description: (
          document.getElementById('edit-description') as HTMLTextAreaElement
        ).value,
        host_name: (
          document.getElementById('edit-host-name') as HTMLInputElement
        ).value,
        host_email: (
          document.getElementById('edit-host-email') as HTMLInputElement
        ).value,
        duration: parseInt(
          (document.getElementById('edit-duration') as HTMLInputElement).value
        ),
        capacity:
          parseInt(
            (document.getElementById('edit-capacity') as HTMLInputElement).value
          ) || null,
        activity_type: (
          document.getElementById('edit-activity-type') as HTMLInputElement
        ).value,
        equipment_needed: (
          document.getElementById('edit-equipment') as HTMLTextAreaElement
        ).value,
        time_preference: (
          document.getElementById('edit-time-preference') as HTMLTextAreaElement
        ).value,
        notes: (document.getElementById('edit-notes') as HTMLTextAreaElement)
          .value,
        status: editStatusSelect.value,
      };

      // Include schedule fields if status is scheduled
      if (editStatusSelect.value === 'scheduled') {
        data.scheduled_start = (
          document.getElementById('edit-scheduled-start') as HTMLInputElement
        ).value;
        data.scheduled_end = (
          document.getElementById('edit-scheduled-end') as HTMLInputElement
        ).value;
        data.location = (
          document.getElementById('edit-location') as HTMLInputElement
        ).value;
      } else {
        data.scheduled_start = null;
        data.scheduled_end = null;
        data.location = null;
      }

      try {
        const response = await fetch(`/api/admin/activities/${activityId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          closeEditModal();
          window.location.reload();
        } else {
          const result = await response.json();
          editError!.querySelector('p')!.textContent =
            result.error || 'Failed to update activity';
          editError?.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error updating activity:', error);
        editError!.querySelector('p')!.textContent = 'An error occurred';
        editError?.classList.remove('hidden');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    });

    // Schedule Modal
    const scheduleModal = document.getElementById('schedule-modal');
    const scheduleForm = document.getElementById(
      'schedule-form'
    ) as HTMLFormElement;
    const scheduleError = document.getElementById('schedule-error');

    document.querySelectorAll('.schedule-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const button = e.target as HTMLButtonElement;
        const activityId = button.dataset.activityId;
        const activity = activitiesData.find(
          (a) => a.id === parseInt(activityId || '0')
        );

        if (activity) {
          (
            document.getElementById('schedule-activity-id') as HTMLInputElement
          ).value = activity.id;
          (
            document.getElementById(
              'schedule-activity-title'
            ) as HTMLSpanElement
          ).textContent = activity.title;
          scheduleModal?.classList.remove('hidden');
        }
      });
    });

    function closeScheduleModal() {
      scheduleModal?.classList.add('hidden');
      scheduleForm?.reset();
      scheduleError?.classList.add('hidden');
    }

    document
      .getElementById('close-schedule-modal')
      ?.addEventListener('click', closeScheduleModal);
    document
      .getElementById('cancel-schedule')
      ?.addEventListener('click', closeScheduleModal);

    scheduleForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const activityId = (
        document.getElementById('schedule-activity-id') as HTMLInputElement
      ).value;
      const saveBtn = document.getElementById(
        'save-schedule'
      ) as HTMLButtonElement;

      saveBtn.disabled = true;
      saveBtn.textContent = 'Scheduling...';

      const data = {
        scheduled_start: (
          document.getElementById('schedule-start') as HTMLInputElement
        ).value,
        scheduled_end: (
          document.getElementById('schedule-end') as HTMLInputElement
        ).value,
        location: (
          document.getElementById('schedule-location') as HTMLInputElement
        ).value,
      };

      try {
        const response = await fetch(
          `/api/admin/activities/${activityId}/schedule`,
          {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          }
        );

        if (response.ok) {
          closeScheduleModal();
          window.location.reload();
        } else {
          const result = await response.json();
          scheduleError!.querySelector('p')!.textContent =
            result.error || 'Failed to schedule activity';
          scheduleError?.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error scheduling activity:', error);
        scheduleError!.querySelector('p')!.textContent = 'An error occurred';
        scheduleError?.classList.remove('hidden');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Schedule Activity';
      }
    });

    // Delete Modal
    const deleteModal = document.getElementById('delete-modal');

    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const button = e.target as HTMLButtonElement;
        const activityId = button.dataset.activityId;
        (
          document.getElementById('delete-activity-id') as HTMLInputElement
        ).value = activityId || '';
        deleteModal?.classList.remove('hidden');
      });
    });

    function closeDeleteModal() {
      deleteModal?.classList.add('hidden');
    }

    document
      .getElementById('cancel-delete')
      ?.addEventListener('click', closeDeleteModal);

    document
      .getElementById('confirm-delete')
      ?.addEventListener('click', async () => {
        const activityId = (
          document.getElementById('delete-activity-id') as HTMLInputElement
        ).value;
        const deleteBtn = document.getElementById(
          'confirm-delete'
        ) as HTMLButtonElement;

        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Deleting...';

        try {
          const response = await fetch(`/api/admin/activities/${activityId}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            closeDeleteModal();
            window.location.reload();
          } else {
            alert('Failed to delete activity');
          }
        } catch (error) {
          console.error('Error deleting activity:', error);
          alert('An error occurred');
        } finally {
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'Delete';
        }
      });
  </script>
</AdminLayout>
