---
import BaseLayout from '../layouts/BaseLayout.astro';
import ScheduleItem from '../components/ScheduleItem.astro';
import { getScheduledActivities } from '../lib/db';

// Fetch all scheduled activities
const activities = getScheduledActivities();

// Group activities by day
const groupedByDay: Record<string, typeof activities> = {};
activities.forEach(activity => {
  if (activity.scheduled_start) {
    const date = new Date(activity.scheduled_start);
    const dayKey = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    if (!groupedByDay[dayKey]) {
      groupedByDay[dayKey] = [];
    }
    groupedByDay[dayKey].push(activity);
  }
});

const days = Object.keys(groupedByDay);

// Extract unique activity types
const activityTypes = Array.from(new Set(activities.map(a => a.activity_type).filter(Boolean)));

// Get current date/time for "What's Happening Now"
const now = new Date();
const currentActivity = activities.find(a => {
  if (a.scheduled_start && a.scheduled_end) {
    const start = new Date(a.scheduled_start);
    const end = new Date(a.scheduled_end);
    return now >= start && now <= end;
  }
  return false;
});

const upcomingActivities = activities
  .filter(a => a.scheduled_start && new Date(a.scheduled_start) > now)
  .slice(0, 3);
---

<BaseLayout title="Schedule - TwinkyMeet" description="View the complete schedule of activities and events">
  <div class="bg-gray-50 min-h-screen">
    <!-- Header Section -->
    <section class="bg-gradient-to-r from-indigo-600 to-indigo-800 text-white py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Event Schedule</h1>
        <p class="text-xl text-indigo-100">Check out what's planned for TwinkyMeet</p>
      </div>
    </section>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

      <!-- What's Happening Now Section -->
      {(currentActivity || upcomingActivities.length > 0) && (
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border-l-4 border-indigo-600">
          {currentActivity ? (
            <div>
              <div class="flex items-center mb-2">
                <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                <h3 class="text-lg font-bold text-gray-900">Happening Now</h3>
              </div>
              <p class="text-2xl font-semibold text-indigo-600 mb-1">{currentActivity.title}</p>
              <p class="text-gray-600">
                {currentActivity.location} • Ends at {new Date(currentActivity.scheduled_end!).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
              </p>
            </div>
          ) : upcomingActivities.length > 0 && (
            <div>
              <h3 class="text-lg font-bold text-gray-900 mb-3">Coming Up Next</h3>
              <div class="space-y-2">
                {upcomingActivities.map(activity => (
                  <div class="flex items-center text-sm">
                    <span class="font-medium text-indigo-600 w-20">
                      {new Date(activity.scheduled_start!).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                    </span>
                    <span class="text-gray-900">{activity.title}</span>
                    <span class="text-gray-500 ml-2">@ {activity.location}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex flex-wrap gap-3 items-center">
          <span class="text-sm font-medium text-gray-700">Filter by:</span>

          <!-- Day Filter -->
          <div class="flex flex-wrap gap-2">
            <button
              class="day-filter px-4 py-2 text-sm border rounded-md transition-colors font-medium"
              data-day="all"
              style="background-color: #2563eb; color: white; border-color: #2563eb;"
            >
              All Days
            </button>
            {days.map(day => (
              <button
                class="day-filter px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                data-day={day}
              >
                {day.split(',')[0]}
              </button>
            ))}
          </div>

          <!-- Time of Day Filter -->
          <div class="border-l border-gray-300 pl-3 ml-2 flex flex-wrap gap-2">
            <button
              class="time-filter px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
              data-time="morning"
            >
              Morning
            </button>
            <button
              class="time-filter px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
              data-time="afternoon"
            >
              Afternoon
            </button>
            <button
              class="time-filter px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
              data-time="evening"
            >
              Evening
            </button>
            <button
              class="time-filter px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
              data-time="night"
            >
              Late Night
            </button>
          </div>

          <!-- Activity Type Filter -->
          {activityTypes.length > 0 && (
            <div class="border-l border-gray-300 pl-3 ml-2 flex flex-wrap gap-2">
              {activityTypes.map(type => (
                <button
                  class="type-filter px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                  data-type={type}
                >
                  {type}
                </button>
              ))}
            </div>
          )}

          <!-- Reset Filters -->
          <button
            id="reset-filters"
            class="ml-auto px-4 py-2 text-sm text-gray-600 hover:text-gray-900 underline"
          >
            Reset Filters
          </button>
        </div>
      </div>

      <!-- Schedule Content -->
      {activities.length === 0 ? (
        <!-- Empty State -->
        <div class="bg-white rounded-lg shadow-sm p-12 text-center">
          <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">No Activities Scheduled Yet</h3>
          <p class="text-gray-600 mb-6">
            The schedule is being finalized. Check back soon or propose your own activity!
          </p>
          <div class="flex justify-center gap-4">
            <a
              href="/submit-activity"
              class="inline-block text-white px-6 py-2 rounded-lg font-medium transition-colors"
              style="background-color: #4f46e5;"
            >
              Suggest an Activity
            </a>
            <a
              href="/activities"
              class="inline-block bg-white text-indigo-600 px-6 py-2 rounded-lg font-medium border-2 border-indigo-600 hover:bg-indigo-50 transition-colors"
            >
              View All Activities
            </a>
          </div>
        </div>
      ) : (
        <!-- Activities grouped by day -->
        <div id="schedule-container" class="space-y-8">
          {days.map(day => (
            <div class="day-section" data-day={day}>
              <div class="flex items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">{day}</h2>
                <div class="ml-4 flex-1 h-px bg-gray-300"></div>
              </div>
              <div class="space-y-4">
                {groupedByDay[day].map(activity => (
                  <div
                    class="activity-item"
                    data-day={day}
                    data-time={activity.scheduled_start ? new Date(activity.scheduled_start).getHours() : ''}
                    data-type={activity.activity_type || ''}
                  >
                    <ScheduleItem activity={activity} />
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}

      <!-- No Results Message -->
      <div id="no-results" class="hidden bg-white rounded-lg shadow-sm p-12 text-center">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No Activities Match Your Filters</h3>
        <p class="text-gray-600 mb-4">
          Try adjusting your filters to see more activities.
        </p>
        <button
          id="reset-filters-2"
          class="text-white px-6 py-2 rounded-lg font-medium transition-colors"
          style="background-color: #4f46e5;"
        >
          Reset Filters
        </button>
      </div>

      <!-- Info Box -->
      {activities.length > 0 && (
        <div class="mt-8 bg-indigo-50 border border-indigo-200 rounded-lg p-6">
          <div class="flex">
            <svg class="w-6 h-6 text-indigo-600 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <h3 class="font-semibold text-gray-900 mb-1">Schedule Notes</h3>
              <ul class="text-sm text-gray-700 space-y-1">
                <li>• All times are subject to change. Check back for updates!</li>
                <li>• Participation is entirely optional – join what interests you</li>
                <li>• Some activities may have capacity limits</li>
                <li>• Want to host something? <a href="/submit-activity" class="text-indigo-600 hover:text-indigo-700 underline">Submit an activity</a></li>
              </ul>
            </div>
          </div>
        </div>
      )}

      <!-- View All Activities Link -->
      {activities.length > 0 && (
        <div class="text-center mt-8">
          <a
            href="/activities"
            class="inline-flex items-center text-indigo-600 hover:text-indigo-700 font-medium"
          >
            View detailed activity catalog
            <svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      )}

    </div>
  </div>

  <script>
    // Filter state
    let selectedDay = 'all';
    let selectedTime: string | null = null;
    let selectedType: string | null = null;

    // Get elements
    const dayFilters = document.querySelectorAll('.day-filter');
    const timeFilters = document.querySelectorAll('.time-filter');
    const typeFilters = document.querySelectorAll('.type-filter');
    const resetButtons = document.querySelectorAll('#reset-filters, #reset-filters-2');
    const scheduleContainer = document.getElementById('schedule-container');
    const noResults = document.getElementById('no-results');

    // Helper function to determine time of day
    function getTimeOfDay(hour: number): string {
      if (hour >= 6 && hour < 12) return 'morning';
      if (hour >= 12 && hour < 17) return 'afternoon';
      if (hour >= 17 && hour < 22) return 'evening';
      return 'night';
    }

    // Filter activities
    function filterActivities() {
      const activityItems = document.querySelectorAll('.activity-item');
      const daySections = document.querySelectorAll('.day-section');
      let visibleCount = 0;

      // First, hide all day sections
      daySections.forEach(section => {
        (section as HTMLElement).style.display = 'none';
      });

      // Filter activity items
      activityItems.forEach(item => {
        const htmlItem = item as HTMLElement;
        const itemDay = htmlItem.dataset.day || '';
        const itemTimeHour = parseInt(htmlItem.dataset.time || '0');
        const itemType = htmlItem.dataset.type || '';

        const matchesDay = selectedDay === 'all' || itemDay === selectedDay;
        const matchesTime = !selectedTime || getTimeOfDay(itemTimeHour) === selectedTime;
        const matchesType = !selectedType || itemType === selectedType;

        if (matchesDay && matchesTime && matchesType) {
          htmlItem.style.display = '';
          visibleCount++;

          // Show the parent day section
          const parentSection = htmlItem.closest('.day-section') as HTMLElement;
          if (parentSection) {
            parentSection.style.display = '';
          }
        } else {
          htmlItem.style.display = 'none';
        }
      });

      // Show/hide no results message
      if (scheduleContainer && noResults) {
        if (visibleCount === 0) {
          scheduleContainer.style.display = 'none';
          noResults.classList.remove('hidden');
        } else {
          scheduleContainer.style.display = '';
          noResults.classList.add('hidden');
        }
      }
    }

    // Update button states
    function updateButtonStates() {
      // Day filters
      dayFilters.forEach(btn => {
        const htmlBtn = btn as HTMLElement;
        if (htmlBtn.dataset.day === selectedDay) {
          htmlBtn.style.backgroundColor = '#2563eb';
          htmlBtn.style.color = 'white';
          htmlBtn.style.borderColor = '#2563eb';
        } else {
          htmlBtn.style.backgroundColor = '';
          htmlBtn.style.color = '';
          htmlBtn.style.borderColor = '';
        }
      });

      // Time filters
      timeFilters.forEach(btn => {
        const htmlBtn = btn as HTMLElement;
        if (htmlBtn.dataset.time === selectedTime) {
          htmlBtn.style.backgroundColor = '#2563eb';
          htmlBtn.style.color = 'white';
          htmlBtn.style.borderColor = '#2563eb';
        } else {
          htmlBtn.style.backgroundColor = '';
          htmlBtn.style.color = '';
          htmlBtn.style.borderColor = '';
        }
      });

      // Type filters
      typeFilters.forEach(btn => {
        const htmlBtn = btn as HTMLElement;
        if (htmlBtn.dataset.type === selectedType) {
          htmlBtn.style.backgroundColor = '#2563eb';
          htmlBtn.style.color = 'white';
          htmlBtn.style.borderColor = '#2563eb';
        } else {
          htmlBtn.style.backgroundColor = '';
          htmlBtn.style.color = '';
          htmlBtn.style.borderColor = '';
        }
      });
    }

    // Day filter handlers
    dayFilters.forEach(btn => {
      btn.addEventListener('click', () => {
        const htmlBtn = btn as HTMLElement;
        selectedDay = htmlBtn.dataset.day || 'all';
        updateButtonStates();
        filterActivities();
      });
    });

    // Time filter handlers
    timeFilters.forEach(btn => {
      btn.addEventListener('click', () => {
        const htmlBtn = btn as HTMLElement;
        const time = htmlBtn.dataset.time || null;
        selectedTime = selectedTime === time ? null : time;
        updateButtonStates();
        filterActivities();
      });
    });

    // Type filter handlers
    typeFilters.forEach(btn => {
      btn.addEventListener('click', () => {
        const htmlBtn = btn as HTMLElement;
        const type = htmlBtn.dataset.type || null;
        selectedType = selectedType === type ? null : type;
        updateButtonStates();
        filterActivities();
      });
    });

    // Reset filters
    resetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDay = 'all';
        selectedTime = null;
        selectedType = null;
        updateButtonStates();
        filterActivities();
      });
    });
  </script>
</BaseLayout>
