---
import { Image } from 'astro:assets';
import BaseLayout from '../layouts/BaseLayout.astro';
import ImageHero from '../components/ImageHero.astro';
import PhotoCard from '../components/PhotoCard.astro';
import ActivityCard from '../components/ActivityCard.astro';
import { getSetting, getAllActivities } from '../lib/db';

// Fetch event details from settings
const eventDateStart = getSetting('event_date_start') || '2026-07-01';
const eventDateEnd = getSetting('event_date_end') || '2026-07-05';
const location = getSetting('location') || 'Location TBD';

// Format dates for display - add T00:00:00 to parse as local time instead of UTC
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr + 'T00:00:00');
  return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
};

const startDate = new Date(eventDateStart + 'T00:00:00');
const endDate = new Date(eventDateEnd + 'T00:00:00');

// Format date range display - check if same month or different months
const isSameMonth = startDate.getMonth() === endDate.getMonth() && startDate.getFullYear() === endDate.getFullYear();
const dateDisplay = isSameMonth
  ? `${startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}-${endDate.getDate()}, ${endDate.getFullYear()}`
  : `${startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}-${endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}, ${endDate.getFullYear()}`;

// Get sample activities for highlights (upcoming scheduled activities)
const scheduledActivities = getAllActivities('scheduled').slice(0, 3);

// Try to import hero image (will use gradient fallback if not present)
let heroImage;
try {
  heroImage = await import('../images/hero/home-hero.jpg');
} catch {
  heroImage = undefined;
}

// Try to import highlight images
let highlightImages = [];
for (let i = 1; i <= 3; i++) {
  try {
    const img = await import(`../images/highlights/moment-${i}.jpg`);
    highlightImages.push(img.default);
  } catch {
    // Image not found, skip it
  }
}

// Try to import featured activity images
let featuredImages = [];
for (let i = 1; i <= 3; i++) {
  try {
    const img = await import(`../images/activities/featured-${i}.jpg`);
    featuredImages.push(img.default);
  } catch {
    // Image not found, skip it
  }
}

// Import community background photo
let communityPhoto;
try {
  communityPhoto = await import('../images/gallery/community-social.jpg');
} catch {
  communityPhoto = undefined;
}
---

<BaseLayout title="TwinkyMeet - Home">
	<div class="relative">
		<!-- Fixed background photo with overlay -->
		<div class="fixed inset-0 -z-10 top-0">
			{communityPhoto?.default && (
				<>
					<Image
						src={communityPhoto.default}
						alt="TwinkyMeet community gathering"
						class="w-full h-full object-cover"
						widths={[640, 1024, 1920, 2560]}
						sizes="100vw"
						loading="eager"
					/>
					<!-- Teal overlay -->
					<div class="absolute inset-0 bg-primary-500 opacity-85 md:opacity-75"></div>
				</>
			)}
			{!communityPhoto?.default && (
				<div class="absolute inset-0 bg-gradient-to-r from-primary-600 to-primary-800"></div>
			)}
		</div>

		<!-- Content (positioned above background) -->
		<div class="relative z-0">
		<!-- Hero Section with ImageHero Component -->
		<ImageHero
			image={heroImage?.default}
			title="Welcome to TwinkyMeet"
			subtitle="A summer mini-convention for our close-knit furry community gathering"
			showCountdown={true}
		>
			<!-- Event Details -->
			<div class="flex flex-col sm:flex-row justify-center items-center gap-6 text-white mb-8">
				<div class="flex items-center">
					<svg class="w-6 h-6 mr-2 text-accent-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
					</svg>
					<span class="font-semibold">{dateDisplay}</span>
				</div>
				<div class="flex items-center">
					<svg class="w-6 h-6 mr-2 text-accent-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
					</svg>
					<span class="font-semibold">{location}</span>
				</div>
			</div>

			<!-- CTA Buttons -->
			<div class="flex flex-col sm:flex-row justify-center gap-4">
				<a
					href="/rsvp"
					class="inline-block bg-accent-500 text-white px-8 py-3 rounded-lg font-bold hover:bg-accent-600 transition-all shadow-lg hover:shadow-xl hover-lift"
				>
					RSVP Now
				</a>
				<a
					href="/submit-activity"
					class="inline-block bg-white text-primary-700 px-8 py-3 rounded-lg font-bold border-2 border-white hover:bg-primary-50 transition-all"
				>
					Submit Activity
				</a>
			</div>
		</ImageHero>

		<!-- Photo Highlights Section -->
		{highlightImages.length > 0 && (
			<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
				<h2 class="text-3xl md:text-4xl font-bold text-gray-900 text-center mb-12">
					Moments from <span class="text-accent-600">TwinkyMeet</span>
				</h2>
				<div class="grid md:grid-cols-3 gap-6">
					{highlightImages.map((img, index) => {
						const captions = [
							'Making memories together',
							'Activities and adventures',
							'Friends and fun times'
						];
						return (
							<PhotoCard
								image={img}
								caption={captions[index]}
								aspectRatio="landscape"
							/>
						);
					})}
				</div>
			</section>
		)}

		<!-- Quick Info Section -->
		<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
			<div class="grid md:grid-cols-3 gap-8">
				<div class="bg-white/95 p-6 rounded-lg hover-lift border-l-4 border-primary-500" style="box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.1);">
					<div class="text-primary-600 mb-3">
						<svg class="w-12 h-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
					</div>
					<h3 class="text-xl font-semibold text-gray-900 mb-2 text-center">View Schedule</h3>
					<p class="text-gray-600 text-center mb-4">Check out the planned activities and events</p>
					<div class="text-center">
						<a href="/schedule" class="text-accent-600 hover:text-accent-700 font-semibold">View Schedule →</a>
					</div>
				</div>

				<div class="bg-white/95 p-6 rounded-lg hover-lift border-l-4 border-primary-500" style="box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.1);">
					<div class="text-primary-600 mb-3">
						<svg class="w-12 h-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
					</div>
					<h3 class="text-xl font-semibold text-gray-900 mb-2 text-center">Event Info</h3>
					<p class="text-gray-600 text-center mb-4">Learn more about what to expect</p>
					<div class="text-center">
						<a href="/about" class="text-accent-600 hover:text-accent-700 font-semibold">Learn More →</a>
					</div>
				</div>

				<div class="bg-white/95 p-6 rounded-lg hover-lift border-l-4 border-primary-500" style="box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.1);">
					<div class="text-primary-600 mb-3">
						<svg class="w-12 h-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
						</svg>
					</div>
					<h3 class="text-xl font-semibold text-gray-900 mb-2 text-center">Activities</h3>
					<p class="text-gray-600 text-center mb-4">Browse all planned activities</p>
					<div class="text-center">
						<a href="/activities" class="text-accent-600 hover:text-accent-700 font-semibold">View Activities →</a>
					</div>
				</div>
			</div>
		</section>

		<!-- Featured Activities -->
		{scheduledActivities.length > 0 && (
			<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
				<h2 class="text-3xl md:text-4xl font-bold text-gray-900 text-center mb-12">
					Featured <span class="text-primary-600">Activities</span>
				</h2>
				<div class="grid md:grid-cols-3 gap-8">
					{scheduledActivities.map((activity, index) => (
						<ActivityCard
							activity={activity}
							image={featuredImages[index]}
						/>
					))}
				</div>
				<div class="text-center mt-12">
					<a href="/activities" class="inline-flex items-center text-accent-600 hover:text-accent-700 font-bold text-lg">
						View All Activities
						<svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
						</svg>
					</a>
				</div>
			</section>
		)}
		</div>
	</div>
</BaseLayout>
